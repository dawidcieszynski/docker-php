#!/bin/bash
set -e

# Note: we don't just use "apache2ctl" here because it itself is just a shell-script wrapper around apache2 which provides extra functionality like "apache2ctl start" for launching apache2 in the background.
# (also, when run as "apache2ctl <apache args>", it does not use "exec", which leaves an undesirable resident shell process)

: "${APACHE_CONFDIR:=/etc/apache2}"
: "${APACHE_ENVVARS:=$APACHE_CONFDIR/envvars}"
if test -f "$APACHE_ENVVARS"; then
	. "$APACHE_ENVVARS"
fi

# Apache gets grumpy about PID files pre-existing
: "${APACHE_PID_FILE:=${APACHE_RUN_DIR:=/var/run/apache2}/apache2.pid}"
rm -f "$APACHE_PID_FILE"

# Setup SSL
if [[ ! -f /usr/local/share/ca-certificates/Server.crt || ! -f /usr/local/share/ca-certificates/Server.key ]] ; then
	if [[ ! -f /usr/local/share/ca-certificates/RootCA.key || ! -f /usr/local/share/ca-certificates/RootCA.pem ]] ; then
		echo "Generating root CA"

    ROOTCACONF=/usr/local/share/ca-certificates/RootCA.conf
		if [[ ! -f ${ROOTCACONF} ]]; then
		  ROOTCACONF=/certconf/RootCA.conf
		fi

    if [[ ! -f /usr/local/share/ca-certificates/RootCA.key ]]; then
		  openssl genrsa -out /usr/local/share/ca-certificates/RootCA.key 2048
		fi

		openssl req -x509 -new -nodes -key /usr/local/share/ca-certificates/RootCA.key -sha256 -days 36500 -out /usr/local/share/ca-certificates/RootCA.pem -config ${ROOTCACONF}
	fi
	
	# You can change the key settings in ServerCert.conf
	echo "Creating server certificate"

	LOCALKEYCONF=/usr/local/share/ca-certificates/ServerCert.conf
	if [[ ! -f ${LOCALKEYCONF} ]]; then
    LOCALKEYCONF=/certconf/ServerCert.conf
  fi

  if [[ ! -f /usr/local/share/ca-certificates/Server.key ]]; then
	  openssl genrsa -out /usr/local/share/ca-certificates/Server.key 2048
	fi

	openssl req -new -key /usr/local/share/ca-certificates/Server.key -out /usr/local/share/ca-certificates/Server.csr -config ${LOCALKEYCONF}
	openssl x509 -req -in /usr/local/share/ca-certificates/Server.csr -CA /usr/local/share/ca-certificates/RootCA.pem -CAkey /usr/local/share/ca-certificates/RootCA.key -CAcreateserial -out /usr/local/share/ca-certificates/Server.crt -days 36500 -sha256 -extensions v3_req -extfile ${LOCALKEYCONF}
fi

exec apache2 -DFOREGROUND "$@"